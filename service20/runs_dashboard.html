<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service20 Runs & Architecture Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@9.4.3/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose'
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #4a5568;
        }

        .tab-button:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f6f8fb 0%, #ffffff 100%);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 0.9rem;
            color: #718096;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
        }

        .stat-card .subtext {
            font-size: 0.85rem;
            color: #a0aec0;
            margin-top: 5px;
        }

        .runs-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            overflow: hidden;
            border-radius: 8px;
        }

        .runs-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .runs-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .runs-table td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .runs-table tbody tr:hover {
            background: #f7fafc;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-completed {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-failed {
            background: #fed7d7;
            color: #742a2a;
        }

        .status-running {
            background: #bee3f8;
            color: #2c5282;
        }

        .status-pending {
            background: #fefcbf;
            color: #744210;
        }

        .diagram-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .diagram-container h2 {
            color: #2d3748;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .mermaid {
            text-align: center;
        }

        .section-title {
            font-size: 1.5rem;
            color: #2d3748;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 0.85rem;
            color: #4a5568;
            font-weight: 600;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.95rem;
            min-width: 200px;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .duration {
            color: #718096;
            font-size: 0.9rem;
        }

        .refresh-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            margin-bottom: 20px;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .info-box {
            background: #ebf8ff;
            border-left: 4px solid #3182ce;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .info-box h4 {
            color: #2c5282;
            margin-bottom: 10px;
        }

        .info-box ul {
            list-style: none;
            padding-left: 0;
        }

        .info-box li {
            color: #2d3748;
            padding: 5px 0;
            padding-left: 20px;
            position: relative;
        }

        .info-box li:before {
            content: "→";
            position: absolute;
            left: 0;
            color: #3182ce;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Service20 Operations Dashboard</h1>
            <p>Intelligent Matching System - Runs & Architecture</p>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('runs')">Research Runs</button>
            <button class="tab-button" onclick="switchTab('history')">Research History</button>
            <button class="tab-button" onclick="switchTab('matching')">Matching Runs</button>
            <button class="tab-button" onclick="switchTab('architecture')">EventBridge Architecture</button>
            <button class="tab-button" onclick="switchTab('workflow')">Workflow Diagrams</button>
        </div>

        <!-- Research Runs Tab -->
        <div id="runs-tab" class="tab-content active">
            <h2 class="section-title">Deep Research Runs</h2>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Runs</h3>
                    <div class="value" id="total-runs">0</div>
                    <div class="subtext">All time</div>
                </div>
                <div class="stat-card">
                    <h3>Completed</h3>
                    <div class="value" id="completed-runs">0</div>
                    <div class="subtext">Success rate: <span id="success-rate">0%</span></div>
                </div>
                <div class="stat-card">
                    <h3>Running</h3>
                    <div class="value" id="running-runs">0</div>
                    <div class="subtext">Currently active</div>
                </div>
                <div class="stat-card">
                    <h3>Failed</h3>
                    <div class="value" id="failed-runs">0</div>
                    <div class="subtext">Requires attention</div>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label>Status</label>
                    <select id="status-filter" onchange="filterRuns()">
                        <option value="all">All Statuses</option>
                        <option value="completed">Completed</option>
                        <option value="running">Running</option>
                        <option value="failed">Failed</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Opportunity Type</label>
                    <select id="type-filter" onchange="filterRuns()">
                        <option value="all">All Types</option>
                        <option value="investment">Investment</option>
                        <option value="funding">Funding</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Search</label>
                    <input type="text" id="search-input" placeholder="Search by ID or city..." oninput="filterRuns()">
                </div>
            </div>

            <button class="refresh-btn" onclick="loadRuns()">Refresh Data</button>

            <table class="runs-table" id="runs-table">
                <thead>
                    <tr>
                        <th>Run ID</th>
                        <th>Type</th>
                        <th>Location</th>
                        <th>Sector</th>
                        <th>Status</th>
                        <th>Started</th>
                        <th>Duration</th>
                        <th>Alert Created</th>
                    </tr>
                </thead>
                <tbody id="runs-tbody">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Research History Tab -->
        <div id="history-tab" class="tab-content">
            <h2 class="section-title">Research History (All Time)</h2>

            <div class="info-box">
                <h4>Historical Research Data</h4>
                <ul>
                    <li>Shows all research runs from service20_investment_opportunities and service20_funding_opportunities tables</li>
                    <li>Includes research iterations, tool calls, and report lengths</li>
                    <li>Filter by type, status, or search by location/sector</li>
                </ul>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Historical Runs</h3>
                    <div class="value" id="total-history">0</div>
                    <div class="subtext">All time research</div>
                </div>
                <div class="stat-card">
                    <h3>Investment Research</h3>
                    <div class="value" id="investment-history">0</div>
                    <div class="subtext">City opportunities</div>
                </div>
                <div class="stat-card">
                    <h3>Funding Research</h3>
                    <div class="value" id="funding-history">0</div>
                    <div class="subtext">Funder profiles</div>
                </div>
                <div class="stat-card">
                    <h3>Avg. Tool Calls</h3>
                    <div class="value" id="avg-tool-calls">0</div>
                    <div class="subtext">Per research run</div>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label>Type Filter</label>
                    <select id="history-type-filter" onchange="filterHistory()">
                        <option value="all">All Types</option>
                        <option value="investment">Investment Only</option>
                        <option value="funding">Funding Only</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Search History</label>
                    <input type="text" id="history-search-input" placeholder="Search by location or sector..." oninput="filterHistory()">
                </div>
            </div>

            <button class="refresh-btn" onclick="loadHistory()">Refresh History</button>

            <table class="runs-table" id="history-table">
                <thead>
                    <tr>
                        <th>Run ID</th>
                        <th>Type</th>
                        <th>Location/Org</th>
                        <th>Sector</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Iterations</th>
                        <th>Tool Calls</th>
                        <th>Report Size</th>
                    </tr>
                </thead>
                <tbody id="history-tbody">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Matching Runs Tab -->
        <div id="matching-tab" class="tab-content">
            <h2 class="section-title">Matching Job Runs</h2>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Matches</h3>
                    <div class="value" id="total-matches">0</div>
                    <div class="subtext">All time</div>
                </div>
                <div class="stat-card">
                    <h3>High Confidence</h3>
                    <div class="value" id="high-confidence-matches">0</div>
                    <div class="subtext">Auto-notified</div>
                </div>
                <div class="stat-card">
                    <h3>Medium Confidence</h3>
                    <div class="value" id="medium-confidence-matches">0</div>
                    <div class="subtext">Needs approval</div>
                </div>
                <div class="stat-card">
                    <h3>Bundled Projects</h3>
                    <div class="value" id="bundled-matches">0</div>
                    <div class="subtext">Multi-city initiatives</div>
                </div>
            </div>

            <button class="refresh-btn" onclick="loadMatchingRuns()">Refresh Data</button>

            <table class="runs-table">
                <thead>
                    <tr>
                        <th>Job ID</th>
                        <th>Date</th>
                        <th>Matches Found</th>
                        <th>High Conf.</th>
                        <th>Medium Conf.</th>
                        <th>Bundled</th>
                        <th>Duration</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="matching-tbody">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- EventBridge Architecture Tab -->
        <div id="architecture-tab" class="tab-content">
            <div class="info-box">
                <h4>EventBridge Architecture Overview</h4>
                <ul>
                    <li>Daily scheduled rule triggers matching job at configured time</li>
                    <li>Lambda function executes matching engine to find opportunities</li>
                    <li>High confidence matches are auto-notified via SQS</li>
                    <li>Medium confidence matches queued for human approval</li>
                    <li>Results stored in PostgreSQL database</li>
                    <li>Alerts created via CNZ API for all participants</li>
                </ul>
            </div>

            <div class="diagram-container">
                <h2>Complete EventBridge Architecture</h2>
                <div class="mermaid">
graph TB
    EB[EventBridge Rule]
    Lambda1[Lambda matching-job-runner]
    ME[MatchMaker Engine]
    PG1[(PostgreSQL DB)]
    Scorer[Compatibility Scorer]
    BA[Bundle Analyzer]
    SQS1[SQS match-results]
    SQS2[SQS match-approvals]
    PG2[(PostgreSQL matches)]
    Lambda2[Lambda alert-creator]
    PG3[(PostgreSQL alerts)]
    CNZ[CNZ API]
    Portal[Admin Portal]
    CW[CloudWatch]
    LF[Langfuse]

    EB -->|Triggers| Lambda1
    Lambda1 -->|Invokes| ME
    ME -->|Fetches| PG1
    ME -->|Runs| Scorer
    ME -->|Bundles| BA
    ME -->|High Conf| SQS1
    ME -->|Medium Conf| SQS2
    ME -->|Stores| PG2
    SQS1 -->|Auto-Notify| Lambda2
    Lambda2 -->|Creates| PG3
    Lambda2 -->|Notifies| CNZ
    SQS2 -->|Awaits| Portal
    Portal -->|Approved| Lambda2
    Lambda1 -->|Logs| CW
    Lambda2 -->|Logs| CW
    ME -->|Telemetry| LF

    style EB fill:#ff9999
    style Lambda1 fill:#99ccff
    style Lambda2 fill:#99ccff
    style ME fill:#99ff99
    style Scorer fill:#ffcc99
    style BA fill:#ffcc99
    style SQS1 fill:#ffff99
    style SQS2 fill:#ffff99
    style PG1 fill:#cc99ff
    style PG2 fill:#cc99ff
    style PG3 fill:#cc99ff
    style CNZ fill:#ff99cc
                </div>
            </div>

            <div class="diagram-container">
                <h2>SQS Queue Architecture</h2>
                <div class="mermaid">
graph LR
    API[API Manual Input]
    Agent1[Investment Agent]
    Agent2[Funding Agent]
    Matcher[Matching Engine]

    Q1[investment opportunities]
    Q2[funding opportunities]
    Q3[research results]
    Q4[match requests]
    Q5[match results]
    Q6[match approvals]

    Worker1[Research Worker]
    Worker2[Alert Creator]
    Admin[Admin Portal]

    API -->|Publishes| Q1
    API -->|Publishes| Q2
    Agent1 -->|Results| Q3
    Agent2 -->|Results| Q3
    Matcher -->|Triggers| Q4
    Matcher -->|High Conf| Q5
    Matcher -->|Medium Conf| Q6
    Q1 -->|Consumes| Worker1
    Q2 -->|Consumes| Worker1
    Q5 -->|Consumes| Worker2
    Q6 -->|Reviews| Admin
    Admin -->|Approved| Q5

    style Q1 fill:#ffff99
    style Q2 fill:#ffff99
    style Q3 fill:#ffff99
    style Q4 fill:#99ccff
    style Q5 fill:#99ff99
    style Q6 fill:#ff9999
                </div>
            </div>
        </div>

        <!-- Workflow Diagrams Tab -->
        <div id="workflow-tab" class="tab-content">
            <div class="diagram-container">
                <h2>Daily Matching Job Workflow</h2>
                <div class="mermaid">
sequenceDiagram
    participant EB as EventBridge
    participant Lambda as Lambda Function
    participant Engine as Matching Engine
    participant DB as PostgreSQL
    participant SQS as SQS Queues
    participant CNZ as CNZ API

    EB->>Lambda: Trigger Daily 02 00 UTC
    Lambda->>Engine: Execute run_daily_matching_job 30

    Engine->>DB: Fetch active alerts last 30 days
    DB-->>Engine: Return opportunities and funders

    Engine->>Engine: Run compatibility scoring
    Engine->>Engine: Find bundling combinations

    alt High Confidence Above 0.80
        Engine->>DB: Store match requires_approval false
        Engine->>SQS: Send to match-results queue
        SQS->>Lambda: Trigger alert-creator
        Lambda->>DB: Create alerts for participants
        Lambda->>CNZ: Send notifications
    else Medium Confidence 0.60 to 0.80
        Engine->>DB: Store match requires_approval true
        Engine->>SQS: Send to match-approvals queue
        Note over SQS: Waits for human approval
    else Low Confidence Below 0.60
        Engine->>Engine: Log only no alerts
    end

    Engine-->>Lambda: Return job summary
    Lambda->>EB: Complete with status
                </div>
            </div>

            <div class="diagram-container">
                <h2>Research to Alert Workflow</h2>
                <div class="mermaid">
flowchart TD
    Start[User Submits Research Request] --> Type{Request Type?}

    Type -->|Investment| IQ[investment-opportunities Queue]
    Type -->|Funding| FQ[funding-opportunities Queue]

    IQ --> IAgent[Investment Research Agent]
    FQ --> FAgent[Funding Research Agent]

    IAgent --> Research[Deep Research Workflow]
    FAgent --> Research

    Research --> Results[Research Results]
    Results --> DB1[(PostgreSQL Store Research)]
    Results --> Alert[Create Enhanced Alert]

    Alert --> DB2[(PostgreSQL service20_alerts)]
    Alert --> API[CNZ API External Alert]

    DB2 --> Wait[Wait for Daily Matching]

    Wait --> Match[Matching Engine Runs]
    Match --> Found{Match Found?}

    Found -->|Yes High Conf| Auto[Auto-Notify Participants]
    Found -->|Yes Medium Conf| Approval[Queue for Approval]
    Found -->|No| End[End]

    Auto --> Notify[Send Match Alerts]
    Approval --> Review[Human Review]
    Review -->|Approved| Notify
    Review -->|Rejected| End

    Notify --> End

    style Start fill:#99ccff
    style Research fill:#ffcc99
    style Match fill:#99ff99
    style Auto fill:#99ff99
    style Approval fill:#ffff99
    style Notify fill:#ff99cc
                </div>
            </div>

            <div class="diagram-container">
                <h2>Compatibility Scoring Algorithm</h2>
                <div class="mermaid">
graph TD
    Start[Funder and Opportunities] --> Sector[Sector Alignment Weight 30pct]
    Start --> Financial[Financial Fit Weight 25pct]
    Start --> Timeline[Timeline Compatibility Weight 20pct]
    Start --> ROI[ROI Expectations Weight 15pct]
    Start --> Tech[Technical Match Weight 10pct]

    Sector --> S1{Same Sector?}
    S1 -->|Yes| S2[Score 1.0]
    S1 -->|Similar| S3[Score 0.7]
    S1 -->|Different| S4[Score 0.0]

    Financial --> F1{Meets Minimum?}
    F1 -->|Yes| F2{Within Range?}
    F1 -->|No| F3[Score 0.0]
    F2 -->|Yes| F4[Score 1.0]
    F2 -->|No| F5[Score 0.5]

    Timeline --> T1{Timeline Aligned?}
    T1 -->|Yes| T2[Score 1.0]
    T1 -->|Partial| T3[Score 0.6]
    T1 -->|No| T4[Score 0.0]

    ROI --> R1{ROI meets Expected?}
    R1 -->|Yes Above 5pct| R2[Score 1.0]
    R1 -->|Yes Within 5pct| R3[Score 0.8]
    R1 -->|Below| R4[Score 0.3]

    Tech --> Tech1{Tech Compatible?}
    Tech1 -->|Yes| Tech2[Score 1.0]
    Tech1 -->|Partial| Tech3[Score 0.5]
    Tech1 -->|No| Tech4[Score 0.0]

    S2 --> Weighted[Weighted Sum]
    S3 --> Weighted
    S4 --> Weighted
    F2 --> Weighted
    F3 --> Weighted
    F4 --> Weighted
    F5 --> Weighted
    T2 --> Weighted
    T3 --> Weighted
    T4 --> Weighted
    R2 --> Weighted
    R3 --> Weighted
    R4 --> Weighted
    Tech2 --> Weighted
    Tech3 --> Weighted
    Tech4 --> Weighted

    Weighted --> Final{Final Score}
    Final -->|Above 0.80| High[High Confidence Auto-Notify]
    Final -->|0.60 to 0.80| Medium[Medium Confidence Needs Approval]
    Final -->|Below 0.60| Low[Low Confidence Log Only]

    style Start fill:#99ccff
    style Weighted fill:#ffcc99
    style High fill:#99ff99
    style Medium fill:#ffff99
    style Low fill:#ff9999
                </div>
            </div>
        </div>
    </div>

    <script>
        // API endpoint configuration
        const API_BASE_URL = 'http://localhost:8898';

        // Store current data
        let currentRuns = [];
        let currentMatches = [];

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');

            // Activate button
            event.target.classList.add('active');
        }

        // Fetch alerts from API
        async function fetchAlerts() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/alerts`);
                const data = await response.json();

                if (data.success && data.alerts) {
                    currentRuns = data.alerts;
                    return data.alerts;
                } else {
                    console.error('API returned error:', data.error);
                    return [];
                }
            } catch (error) {
                console.error('Failed to fetch alerts:', error);
                // Show error message to user
                const tbody = document.getElementById('runs-tbody');
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#742a2a; padding:20px;">Error loading data. Make sure the API server is running on port 8898.</td></tr>';
                return [];
            }
        }

        // Fetch matches from API
        async function fetchMatches() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/matches`);
                const data = await response.json();

                if (data.success && data.matches) {
                    currentMatches = data.matches;
                    return data.matches;
                } else {
                    console.error('API returned error:', data.error);
                    return [];
                }
            } catch (error) {
                console.error('Failed to fetch matches:', error);
                // Show error message to user
                const tbody = document.getElementById('matching-tbody');
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#742a2a; padding:20px;">Error loading data. Make sure the API server is running on port 8898.</td></tr>';
                return [];
            }
        }

        // Load runs data
        async function loadRuns() {
            const runs = await fetchAlerts();
            updateRunsStats(runs);
            displayRuns(runs);
        }

        function updateRunsStats(runs) {
            const total = runs.length;
            const completed = runs.filter(r => r.status === 'completed').length;
            const running = runs.filter(r => r.status === 'running').length;
            const failed = runs.filter(r => r.status === 'failed').length;
            const successRate = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('total-runs').textContent = total;
            document.getElementById('completed-runs').textContent = completed;
            document.getElementById('running-runs').textContent = running;
            document.getElementById('failed-runs').textContent = failed;
            document.getElementById('success-rate').textContent = successRate + '%';
        }

        function displayRuns(runs) {
            const tbody = document.getElementById('runs-tbody');
            tbody.innerHTML = '';

            if (runs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#718096; padding:20px;">No research runs found.</td></tr>';
                return;
            }

            runs.forEach(run => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${run.id}</strong></td>
                    <td>${run.type}</td>
                    <td>${run.location}</td>
                    <td>${run.sector.replace('_', ' ')}</td>
                    <td><span class="status-badge status-${run.status}">${run.status}</span></td>
                    <td>${run.started}</td>
                    <td class="duration">${run.duration}</td>
                    <td>${run.alertCreated ? '✅' : '❌'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterRuns() {
            const statusFilter = document.getElementById('status-filter').value;
            const typeFilter = document.getElementById('type-filter').value;
            const searchTerm = document.getElementById('search-input').value.toLowerCase();

            let filtered = currentRuns.filter(run => {
                const matchesStatus = statusFilter === 'all' || run.status === statusFilter;
                const matchesType = typeFilter === 'all' || run.type === typeFilter;
                const matchesSearch = searchTerm === '' ||
                    run.id.toLowerCase().includes(searchTerm) ||
                    run.location.toLowerCase().includes(searchTerm) ||
                    run.sector.toLowerCase().includes(searchTerm);

                return matchesStatus && matchesType && matchesSearch;
            });

            displayRuns(filtered);
        }

        // Load matching runs data
        async function loadMatchingRuns() {
            const matches = await fetchMatches();
            updateMatchingStats(matches);
            displayMatchingRuns(matches);
        }

        function updateMatchingStats(runs) {
            const totalMatches = runs.reduce((sum, run) => sum + run.matchesFound, 0);
            const highConfidence = runs.reduce((sum, run) => sum + run.highConfidence, 0);
            const mediumConfidence = runs.reduce((sum, run) => sum + run.mediumConfidence, 0);
            const bundled = runs.reduce((sum, run) => sum + run.bundled, 0);

            document.getElementById('total-matches').textContent = totalMatches;
            document.getElementById('high-confidence-matches').textContent = highConfidence;
            document.getElementById('medium-confidence-matches').textContent = mediumConfidence;
            document.getElementById('bundled-matches').textContent = bundled;
        }

        function displayMatchingRuns(runs) {
            const tbody = document.getElementById('matching-tbody');
            tbody.innerHTML = '';

            if (runs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#718096; padding:20px;">No matching runs found.</td></tr>';
                return;
            }

            runs.forEach(run => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${run.id}</strong></td>
                    <td>${run.date}</td>
                    <td>${run.matchesFound}</td>
                    <td>${run.highConfidence}</td>
                    <td>${run.mediumConfidence}</td>
                    <td>${run.bundled}</td>
                    <td class="duration">${run.duration}</td>
                    <td><span class="status-badge status-${run.status}">${run.status}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        // Fetch combined history from API
        async function fetchHistory() {
            try {
                // Fetch both investment and funding history
                const [investmentRes, fundingRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/api/history/investment`),
                    fetch(`${API_BASE_URL}/api/history/funding`)
                ]);

                const investmentData = await investmentRes.json();
                const fundingData = await fundingRes.json();

                let allHistory = [];

                if (investmentData.success && investmentData.history) {
                    allHistory = allHistory.concat(investmentData.history);
                }

                if (fundingData.success && fundingData.history) {
                    allHistory = allHistory.concat(fundingData.history);
                }

                // Sort by date
                allHistory.sort((a, b) => new Date(b.started) - new Date(a.started));

                currentHistory = allHistory;
                return allHistory;
            } catch (error) {
                console.error('Failed to fetch history:', error);
                const tbody = document.getElementById('history-tbody');
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; color:#742a2a; padding:20px;">Error loading history data. Make sure the API server is running on port 8898.</td></tr>';
                return [];
            }
        }

        // Load history data
        async function loadHistory() {
            const history = await fetchHistory();
            updateHistoryStats(history);
            displayHistory(history);
        }

        let currentHistory = [];

        function updateHistoryStats(history) {
            const total = history.length;
            const investment = history.filter(h => h.type === 'investment').length;
            const funding = history.filter(h => h.type === 'funding').length;
            const avgToolCalls = total > 0 ? Math.round(history.reduce((sum, h) => sum + h.tool_calls, 0) / total) : 0;

            document.getElementById('total-history').textContent = total;
            document.getElementById('investment-history').textContent = investment;
            document.getElementById('funding-history').textContent = funding;
            document.getElementById('avg-tool-calls').textContent = avgToolCalls;
        }

        function displayHistory(history) {
            const tbody = document.getElementById('history-tbody');
            tbody.innerHTML = '';

            if (history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; color:#718096; padding:20px;">No historical research runs found.</td></tr>';
                return;
            }

            history.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${item.id}</strong></td>
                    <td>${item.type}</td>
                    <td>${item.location}</td>
                    <td>${item.sector.replace('_', ' ')}</td>
                    <td><span class="status-badge status-${item.status}">${item.status}</span></td>
                    <td>${item.started}</td>
                    <td>${item.iterations}</td>
                    <td>${item.tool_calls}</td>
                    <td>${formatBytes(item.report_length)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function filterHistory() {
            const typeFilter = document.getElementById('history-type-filter').value;
            const searchTerm = document.getElementById('history-search-input').value.toLowerCase();

            let filtered = currentHistory.filter(item => {
                const matchesType = typeFilter === 'all' || item.type === typeFilter;
                const matchesSearch = searchTerm === '' ||
                    item.location.toLowerCase().includes(searchTerm) ||
                    item.sector.toLowerCase().includes(searchTerm) ||
                    item.id.toLowerCase().includes(searchTerm);

                return matchesType && matchesSearch;
            });

            displayHistory(filtered);
        }

        // Initialize on load
        window.addEventListener('load', () => {
            loadRuns();
            loadMatchingRuns();
            loadHistory();
        });
    </script>
</body>
</html>
